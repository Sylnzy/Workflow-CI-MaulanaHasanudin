name: MLflow Model Training CI - Advanced

on:
    push:
        branches:
            - main
        paths:
            - "MLProject/**"
    workflow_dispatch:
    schedule:
        - cron: "0 0 * * 1"

jobs:
    train-and-deploy:
        runs-on: ubuntu-latest

        steps:
            - name: Set up job
              run: echo "Starting MLflow CI run"

            - name: Checkout repository
              uses: actions/checkout@v3

            - name: Set up Python 3.12.7
              uses: actions/setup-python@v4
              with:
                  python-version: "3.12"

            - name: Check Env
              run: |
                  python --version
                  pip --version
                  ls -la

            - name: Cache pip dependencies
              uses: actions/cache@v3
              with:
                  path: ~/.cache/pip
                  key: ${{ runner.os }}-pip-${{ hashFiles('MLProject/requirements.txt') }}
                  restore-keys: |
                      ${{ runner.os }}-pip-

            - name: Install dependencies
              run: |
                  python -m pip install --upgrade pip
                  pip install mlflow==2.19.0
                  pip install -r MLProject/requirements.txt

            - name: Run MLflow project
              working-directory: MLProject
              env:
                  MLFLOW_TRACKING_URI: file:./mlruns
                  MLFLOW_NO_CONDA: "true"
                  MLFLOW_ENV_MANAGER: local
              run: |
                  rm -rf mlruns
                          mlflow run . --env-manager=local --experiment-name "crop_recommendation_ci" -P n_estimators=200 -P max_depth=20 -P test_size=0.2 -P data_path=crop_preprocessing.csv

            - name: Get latest MLflow run_id
              id: get_run
              working-directory: MLProject
              run: |
                  RUN_ID=$(find mlruns -type f -name "meta.yaml" | sort | tail -n 1 | xargs dirname | xargs basename)
                  EXP_ID=$(find mlruns -type f -name "meta.yaml" | sort | tail -n 1 | awk -F/ '{print $(NF-2)}')
                  MODEL_PATH=$(find mlruns -type d -path "*/artifacts/model" | sort | tail -n 1)
                  echo "RUN_ID=$RUN_ID" >> $GITHUB_OUTPUT
                  echo "EXP_ID=$EXP_ID" >> $GITHUB_OUTPUT
                  echo "MODEL_PATH=$MODEL_PATH" >> $GITHUB_OUTPUT
                  echo "Run ID: $RUN_ID"
                  echo "Experiment ID: $EXP_ID"
                  echo "Model path: $MODEL_PATH"

            - name: Collect artifacts
              working-directory: MLProject
              run: |
                  mkdir -p artifacts_output
                  RUN_DIR=$(find mlruns -type d -name "artifacts" | sort | tail -n 1)
                  if [ -d "$RUN_DIR" ]; then
                    cp -r "$RUN_DIR"/* artifacts_output/ || true
                  fi
                  find . -name "crop_model.pkl" -o -name "*.png" -o -name "*.json" | xargs -I {} cp {} artifacts_output/ || true
                  ls -la artifacts_output

            - name: Upload artifacts to GitHub
              uses: actions/upload-artifact@v4
              with:
                  name: crop-model-${{ github.run_number }}
                  path: MLProject/artifacts_output/
                  retention-days: 30

            - name: Build Docker Model
              working-directory: MLProject
              run: |
                  MODEL_URI=${{ steps.get_run.outputs.MODEL_PATH }}
                  echo "Building docker image from ${MODEL_URI}"
                  if [ -z "$MODEL_URI" ]; then echo "Model path not found"; exit 1; fi
                  mlflow models build-docker -m "$MODEL_URI" -n "${{ secrets.DOCKER_USERNAME }}/crop-recommendation-model:latest"

            - name: Log in to Docker Hub
              uses: docker/login-action@v2
              with:
                  username: ${{ secrets.DOCKER_USERNAME }}
                  password: ${{ secrets.DOCKER_TOKEN }}

            - name: Tag Docker Image
              run: |
                  docker tag ${{ secrets.DOCKER_USERNAME }}/crop-recommendation-model:latest ${{ secrets.DOCKER_USERNAME }}/crop-recommendation-model:run-${{ github.run_number }}

            - name: Push Docker Image
              run: |
                  docker push ${{ secrets.DOCKER_USERNAME }}/crop-recommendation-model:latest
                  docker push ${{ secrets.DOCKER_USERNAME }}/crop-recommendation-model:run-${{ github.run_number }}

            - name: Post cleanup summary
              run: |
                  echo "CI/CD completed for run ${{ github.run_number }}"
                  echo "Run ID: ${{ steps.get_run.outputs.RUN_ID }}"
